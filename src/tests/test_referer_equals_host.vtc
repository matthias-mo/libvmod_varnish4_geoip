varnishtest "test referer is set and equal to the host header; check if \"X-Geo-IP\" header is not set"
  
server s1 {

  rxreq
  txresp -bodylen 1
  expect req.http.X-Geo-IP == "<undef>"
  
} -start

varnish v1 -vcl+backend {

  import geoip;
    
  sub vcl_recv {
    if (req.restarts == 0 && (req.method == "GET" || req.method == "POST")) {
      geoip.set_country_header("178.188.144.54");
    }
  }

  sub vcl_hash {
    if (req.http.X-Geo-IP ~ "^country") {
      hash_data(req.http.X-Geo-IP);
    }
  }

} -start

client c1 {

  txreq -url "foo.bar.net"  -hdr "Referer: foo.bar.net/some/path"
  rxresp

} -run
